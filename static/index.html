<html id="dtop" class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="author" content="Dominique Dierickx">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dtop</title>
    <link rel="stylesheet" href="css/foundation.css" />
    <link rel="stylesheet" type="text/css" href="css/htop.css"> 
    <link rel="stylesheet" type="text/css" href="css/colors.min.css"> 
	<script type="text/javascript" src="js/knockout-3.0.0.js"></script>
	<script type="text/javascript" src="js/knockout.simplegrid.3.0.js"></script>
    <script src="js/modernizr.js"></script>
  </head>
  <body style="display: none">
    
	<nav class="top-bar" data-topbar>
	  <ul class="title-area">
	    <li class="name">
	      <h1><a href="#" data-bind="text: 'dtop@' + basicInfo().Hostname"></a></h1>
	    </li>
	  </ul>
	</nav>

    <div class="row">
    </div>

    <script src="js/jquery.js"></script>
    <script src="js/jquery.sparkline.min.js"></script>

    <script src="js/foundation.min.js"></script>
    <script>
      $(document).ready(function () {
      	    $(document).foundation();

	        /** This code runs when everything has been loaded on the page */
	        /* Inline sparklines take their values from the contents of the tag */
	        $('.inlinesparkline').sparkline(); 

	        /* Sparklines can also take their values from the first argument 
	        passed to the sparkline() function */
	        var myvalues = [10,8,5,7,4,4,1];
	        $('.dynamicsparkline').sparkline(myvalues);

	        /* The second argument gives options such as chart type */
	        $('.dynamicbar').sparkline(myvalues, {type: 'bar', barColor: 'green', width: '100%', height: '50px'} );

	        /* Use 'html' instead of an array of values to pass options 
	        to a sparkline with data in the tag */
	        $('.inlinebar').sparkline('html', {type: 'bar', barColor: 'red'} );

      		var ViewModel = function() {
      			var self = this;

				/* observables */
      			self.processFilter = ko.observable("");
      			self.cpu = ko.observable({});
				self.memory = ko.observable({});
				self.processes = ko.observableArray([]);
				self.users = ko.observable({ All: [] });
				self.uptime = ko.observable({});
				self.loadAvg = ko.observable({});
				self.basicInfo = ko.observable({});
				self.process_count = ko.observable(0);
			};

			var viewModel = new ViewModel();

			var loc = window.location;
			var ws_uri = "ws://" + loc.host + loc.pathname + "events";
			var websocket = new WebSocket(ws_uri);

			websocket.onopen = function(evt) { };
			websocket.onclose = function(evt) { };
			websocket.onerror = function(evt) { alert("Websocket error: " + evt); };
			websocket.onmessage = function(evt) {
								obj = JSON.parse(evt.data)

								switch (obj.Q) {
									case "sys.cpu":
										viewModel.cpu(obj.V);
										break;
									case "sys.processes":
										var processes = obj.V;
										viewModel.process_count(processes.length);
										// sort on cpu usage by default
										//processes.sort(sortBy('Cpu', false));
										filtered = $.grep(processes, function(d, i) {
											filter = viewModel.processFilter();
											return d.Command.indexOf(filter) != -1;
										});

										viewModel.processes(filtered);
										break;
									case "sys.memory":
										viewModel.memory(obj.V);
										break;
									case "sys.uptime":
										viewModel.uptime(obj.V);
										break;
									case "sys.users":
										viewModel.users(obj.V);
										break;
									case "sys.loadavg":
										viewModel.loadAvg(obj.V);
										break;
									case "sys.basics":
										viewModel.basicInfo(obj.V);
									case "sig.ready":
										$("body").fadeIn();
								}
			};

			ko.applyBindings(viewModel, document.getElementById("dtop"));
		});
    </script>
  </body>
</html>